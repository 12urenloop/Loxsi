<!DOCTYPE html>
<html lang="en" class="tui-bg-blue-black" id="root">
<head>
  <meta charset="UTF-8">
  <title>Loxsi de Proxy</title>
  <script src="https://cdn.jsdelivr.net/npm/tuicss@2.1.1/dist/tuicss.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tuicss@2.1.1/dist/tuicss.min.css" rel="stylesheet"/>
</head>
<body>
<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%">
  <div class="row">
    <div class="col l6 m6 s6">
      <div class="tui-window" style="margin-bottom: 20px; width: 100%">
        <fieldset class="tui-fieldset">
          <legend>Active Source</legend>
          <span class="tui-fieldset-text right"></span>
          <div id="active-source">
            Loading...
          </div>
        </fieldset>
      </div>
    </div>
    <div class="col l6 m6 s6">
      <div class="tui-window" style="margin-bottom: 20px; width: 100%">
        <fieldset class="tui-fieldset">
          <legend>Active Connections</legend>
          <span class="tui-fieldset-text right"></span>
          <div id="active-connections">
            Loading...
          </div>
        </fieldset>
      </div>
    </div>
    <div class="col l12 m12 s12">
      <div class="tui-window" style="margin-bottom: 20px; width: 100%">
        <fieldset class="tui-fieldset">
          <legend class="center" id="window-title">Source</legend>
          <div>
            Select a source to use for Loxsi data
            <hr class="tui-divider" style="margin-top: 20px">
            <div class="row" id="sources"></div>
          </div>
        </fieldset>
      </div>
      <script>
          let admin_feed = new WebSocket(`ws://${location.host}/admin/feed`);

          admin_feed.onopen = e => {
              document.getElementById('active-source').innerText = "Connecting..."
              document.getElementById('active-connections').innerText = "Connecting..."
              document.getElementById('sources').innerHTML =
                  '<div class="col l6 m12 s12" style="margin-top: 20px">Connecting...</div>'
          }

          let message_handlers = {
              'telraam-health': data => {
                  let root = document.getElementById('root')
                  if (data === 'bad') {
                      root.classList.remove('tui-bg-blue-black')
                      root.classList.add('tui-bg-red-black')
                  } else {
                      root.classList.remove('tui-bg-red-black')
                      root.classList.add('tui-bg-blue-black')
                  }
                  document.getElementById('root').classList.remove('')
              },
              'active-source': data => {
                  document.getElementById('active-source').innerText = data['name']
              },
              'lap-source': data => {
                  let sources = document.getElementById('sources')
                  sources.innerHTML = ""
                  for (let lap_source of data) {
                      console.log(lap_source)
                      sources.innerHTML += '<div class="col l6 m12 s12" style="margin-top: 20px">' +
                          `<button class="tui-button white-168 white-255-hover" onclick="use(this)" value="${lap_source.id}" style="width: 100%">` +
                          `${lap_source.name} </button></div>`
                  }
              },
              'active-connections': data => {
                  document.getElementById('active-connections').innerText = `Count: ${data}`
              }
          }

          admin_feed.onmessage = e => {
              let data = JSON.parse(e.data)
              console.log(data)
              if ('topic' in data && 'data' in data) {
                  if (data['topic'] in message_handlers) {
                      message_handlers[data['topic']](data['data'])
                  }
              } else {
                  console.error(`Invalid message in admin feed: ${data}`)
              }
          }
      </script>
    </div>
    <div class="col l12 m12 s12">
      <div class="tui-window black-168" style="width: 100%">
        <fieldset class="tui-fieldset">
          <legend class="center" id="window-title">Current Status: WIP</legend>
          <span class="tui-fieldset-text" id="chart-message">Connecting...</span>
          <span class="tui-fieldset-text right"></span>
          <div class="tui-chart-vertical" style="width: 100%; height: 200px">
            <div class="tui-chart-display">
              <div class="tui-chart-value red-168" style="height: 80%;">80%</div>
              <div class="tui-chart-value green-168" style="height: 30%;">30%</div>
              <div class="tui-chart-value blue-168" style="height: 50%;">50%</div>
            </div>
            <!--<div class="tui-chart-y-axis">
              <div class="tui-chart-legend">100%</div>
              <div class="tui-chart-legend">75%</div>
              <div class="tui-chart-legend">50%</div>
              <div class="tui-chart-legend">25%</div>
            </div>-->
            <div class="tui-chart-x-axis">
              <div class="tui-chart-legend">t1</div>
              <div class="tui-chart-legend">t2</div>
              <div class="tui-chart-legend">t3</div>
            </div>
          </div>
        </fieldset>
        <script>
            let websocket = new WebSocket(`ws://${location.host}/feed`);

            websocket.onopen = (_event) => {
                document.getElementById('chart-message').remove();
            };

            websocket.onmessage = (event) => {
                console.log(event.data);
            };

            websocket.onclose = (_event) => {
                document.getElementById('chart-timer').parentElement.innerText = "Connection Lost ...";
            }
        </script>
      </div>
    </div>
  </div>
</div>
<script>
    function use(element) {
        fetch(`/api/use/${element.value}`, {
            method: "POST"
        }).then(res => {
            console.log(res)
        })
    }
</script>

</body>
</html>